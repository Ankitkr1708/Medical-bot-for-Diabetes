<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Medical Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .report-card {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-600">Your Personal Medical Agent</h1>
            <p class="text-gray-500 mt-2">Chat about your symptoms or upload a report for a simulated analysis.</p>
            <div class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-3xl mx-auto">
                <p class="font-semibold">⚠️ Disclaimer</p>
                <p class="text-sm">This is a prototype for educational purposes. The analysis provided is simulated and should not be used for actual medical diagnosis. Always consult a qualified healthcare professional.</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Conversation</h2>
                
                <div id="chat-history" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg border">
        
                    <div class="text-center text-gray-400 p-4">Your conversation will be displayed here.</div>
                </div>

                <div class="relative">
                    <textarea id="user-input" class="w-full p-3 pr-24 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" rows="3" placeholder="Describe your symptoms..."></textarea>
                    <button id="send-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                        Send
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send ml-2 h-4 w-4"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                    </button>
                </div>
                
                <div class="mt-4">
                    <label for="pdf-upload" class="block text-sm font-medium text-gray-700 mb-2">Or upload a medical report (PDF):</label>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-indigo-50 file:text-indigo-700
                          hover:file:bg-indigo-100
                        "/>
                        <button id="upload-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                            Upload
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload-cloud ml-2 h-4 w-4"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        </button>
                    </div>
                    <p id="upload-status" class="text-sm text-gray-500 mt-2"></p>
                </div>

                 <div class="mt-6 text-center">
                    <button id="new-chat-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 mr-2 h-4 w-4"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        Start New Report
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text mr-2 text-indigo-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                    Simulated Medical Report
                </h2>
                <div id="report-output" class="space-y-6">
                     <div id="placeholder-report" class="text-center text-gray-400 p-10 border-2 border-dashed rounded-lg">
                        <p>Your generated report will appear here after you send a message or upload a file.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sendBtn = document.getElementById('send-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const userInput = document.getElementById('user-input');
        const pdfUpload = document.getElementById('pdf-upload');
        const uploadStatus = document.getElementById('upload-status');
        const chatHistory = document.getElementById('chat-history');
        const reportOutput = document.getElementById('report-output');
        const placeholderReport = document.getElementById('placeholder-report');

        let conversationLog = [];
        let isFirstMessage = true;

        sendBtn.addEventListener('click', handleSend);
        uploadBtn.addEventListener('click', handleUpload);
        newChatBtn.addEventListener('click', resetSession);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        function handleSend() {
            const message = userInput.value.trim();
            if (!message) return;

            addToChatHistory('user', message);
            conversationLog.push({ role: 'user', content: message });
            userInput.value = '';
            
            processInput(message);
        }

        function handleUpload() {
            const file = pdfUpload.files[0];
            if (!file) {
                uploadStatus.textContent = 'Please select a PDF file first.';
                uploadStatus.style.color = 'red';
                return;
            }

            uploadStatus.textContent = `Uploading "${file.name}"...`;
            uploadStatus.style.color = 'blue';

            setTimeout(() => {
                const fakePdfContent = `Simulated content from ${file.name}. The patient reports persistent headaches and fatigue. Blood pressure is slightly elevated.`;
                addToChatHistory('system', `Uploaded and processed report: ${file.name}`);
                conversationLog.push({ role: 'user', content: fakePdfContent });
                uploadStatus.textContent = `Successfully processed "${file.name}"!`;
                uploadStatus.style.color = 'green';
                pdfUpload.value = '';
                processInput(fakePdfContent);
            }, 1500);
        }

        function addToChatHistory(sender, message) {
            if (isFirstMessage) {
                chatHistory.innerHTML = '';
                isFirstMessage = false;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('mb-4', 'p-3', 'rounded-lg', 'max-w-[90%]');
            
            if (sender === 'user') {
                messageDiv.classList.add('bg-indigo-500', 'text-white', 'ml-auto', 'rounded-br-none');
                messageDiv.innerHTML = `<p class="font-semibold">You</p><p>${message}</p>`;
            } else if (sender === 'ai') {
                messageDiv.classList.add('bg-gray-200', 'text-gray-800', 'mr-auto', 'rounded-bl-none');
                messageDiv.innerHTML = `<p class="font-semibold">Medical Agent</p><p>${message}</p>`;
            } else { // system message
                messageDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'text-center', 'text-sm', 'mx-auto');
                messageDiv.textContent = message;
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

async function processInput(input) {
    addToChatHistory('ai', 'Connecting to analysis engine... Please wait.');

    try {
        const response = await fetch('http://127.0.0.1:5000/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: input,
                history: conversationLog
            }),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const aiResponse = await response.json();

        if (aiResponse.error) {
             throw new Error(aiResponse.error);
        }

        conversationLog.push({ role: 'ai', content: JSON.stringify(aiResponse) });

        updateReport(aiResponse);
        const riskChance = aiResponse.diseases[0]?.chance || 'N/A';
        const summaryMessage = `I've analyzed your information. The statistical model indicates a ${riskChance}% risk related to diabetes. Please see the detailed report for suggestions generated by the AI assistant.`;
        addToChatHistory('ai', summaryMessage);

    } catch (error) {
        console.error("Error communicating with backend:", error);
        addToChatHistory('system', `Error: ${error.message}. Please ensure the Python server and Ollama are running.`);
    }
}

        function updateReport(reportData) {
            if (placeholderReport) {
                placeholderReport.remove();
            }
            reportOutput.innerHTML = '';

            reportData.diseases.forEach(disease => {
                const card = document.createElement('div');
                card.className = 'report-card bg-gray-50 p-5 rounded-xl border border-gray-200 shadow-sm';

                const probabilityColor = disease.chance > 70 ? 'text-red-500' : disease.chance > 40 ? 'text-yellow-500' : 'text-green-500';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-gray-800">${disease.name}</h3>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Probability</p>
                            <p class="font-bold text-2xl ${probabilityColor}">${disease.chance}%</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-indigo-700 mb-2">Suggestions & Lifestyle Advice</h4>
                        <ul class="list-disc list-inside text-gray-600 space-y-1">
                            ${disease.suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-indigo-700 mb-2">Potential Medications (Consult a Doctor)</h4>
                        <ul class="list-disc list-inside text-gray-600 space-y-1">
                            ${disease.medicines.map(m => `<li>${m}</li>`).join('')}
                        </ul>
                    </div>
                `;
                reportOutput.appendChild(card);
            });
        }

        function resetSession() {
            conversationLog = [];
            isFirstMessage = true;
            chatHistory.innerHTML = '<div class="text-center text-gray-400 p-4">Your conversation will be displayed here.</div>';
            reportOutput.innerHTML = `
                <div id="placeholder-report" class="text-center text-gray-400 p-10 border-2 border-dashed rounded-lg">
                    <p>Your generated report will appear here after you send a message or upload a file.</p>
                </div>`;
            userInput.value = '';
            pdfUpload.value = '';
            uploadStatus.textContent = '';
        }

    </script>
</body>
</html>
